<!-- templates/clean_data.html -->
<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ - é£ç”µé¢„æµ‹å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <style>
        .chart-card { @apply bg-white rounded-lg shadow-xl overflow-hidden hover:shadow-2xl transition-shadow; }
        .modal-enter { animation: modalFadeIn 0.3s ease-out; }
        .hidden {
            display: none !important;
        }

        @keyframes modalFadeIn {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 font-sans">
    <!-- å¯¼èˆªæ ï¼ˆä¸base.htmlå®Œå…¨ä¸€è‡´ï¼‰ -->
    <nav class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <a href="/" class="text-2xl font-bold text-indigo-600">ğŸŒªï¸ é£ç”µæ™ºæµ‹</a>
                <div class="hidden md:flex space-x-4">
                    <a href="#upload" class="nav-link">æ•°æ®å¯¼å…¥</a>
                    <a href="#preprocess" class="nav-link">é¢„å¤„ç†</a>
                    <a href="#model" class="nav-link">æ¨¡å‹é€‰æ‹©</a>
                    <a href="#predict" class="nav-link">é¢„æµ‹åˆ†æ</a>
                </div>
            </div>
        </div>
    </nav>
<section class="container mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold mb-6 border-b-2 border-indigo-600 pb-2">âš™ï¸ æ•°æ®æ¸…æ´—é…ç½®</h2>
    
    <!-- é…ç½®è¡¨å• -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- å·¦æ ï¼šå‚æ•°é…ç½® -->
        <div class="chart-card p-6">
            <h3 class="text-lg font-medium text-indigo-600 mb-4">å‚æ•°è®¾ç½®</h3>
            <form id="configForm" class="space-y-4">
                <!-- æ–‡ä»¶é€‰æ‹© -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700">é€‰æ‹©æ•°æ®æ–‡ä»¶</label>
                    <select id="fileSelect" name="current_file" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500">
                        <!-- åŠ¨æ€åŠ è½½æ–‡ä»¶é€‰é¡¹ -->
                    </select>
                </div>

                <!-- å¼‚å¸¸å€¼å¤„ç†éƒ¨åˆ† -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700">å¼‚å¸¸å€¼å¤„ç†æ–¹å¼</label>
                    <div class="mt-2 space-y-2">
                        <label class="inline-flex items-center">
                            <input 
                                type="radio" 
                                name="method" 
                                value="delete" 
                                class="form-radio"
                                id="deleteRadio"
                            >
                            <span class="ml-2">ç›´æ¥åˆ é™¤</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input 
                                type="radio" 
                                name="method" 
                                value="interpolate" 
                                class="form-radio"
                                id="interpolateRadio"
                            >
                            <span class="ml-2">æ’å€¼å¡«è¡¥</span>
                        </label>
                    </div>
                    <div id="interpolateOptions" class="hidden mt-2">
                        <select name="interpolate_method" class="block w-full rounded-md border-gray-300">
                            <option value="linear">çº¿æ€§æ’å€¼</option>
                            <option value="nearest">æœ€è¿‘é‚»æ’å€¼</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700">ç©ºå€¼å¤„ç†ç­–ç•¥</label>
                    <select name="missing_value_strategy" class="mt-1 block w-full rounded-md border-gray-300">
                        <option value="drop">åˆ é™¤ç©ºå€¼</option>
                        <option value="interpolate">æ’å€¼å¡«è¡¥</option>
                        <option value="knn">KNNå¡«è¡¥</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700">
                        æœ€å¤§ç©ºå€¼æ¯”ä¾‹ï¼ˆå½“å‰: <span id="maxMissingValue">30</span>%ï¼‰
                    </label>
                    <input type="range" name="max_missing_ratio" min="0" max="1" step="0.05" 
                           class="w-full mt-2 range-slider" 
                           oninput="document.getElementById('maxMissingValue').textContent = Math.round(this.value*100)">
                </div>
                <!-- æäº¤æŒ‰é’® -->
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="saveConfig()" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                        ä¿å­˜é…ç½®
                    </button>
                    <button type="button" onclick="applyProcessing()" 
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        åº”ç”¨å¤„ç†
                    </button>
                </div>
            </form>
        </div>

        <!-- å³æ ï¼šå‚æ•°å±•ç¤º -->
        <div class="chart-card p-6">
            <h3 class="text-lg font-medium text-indigo-600 mb-4">å½“å‰é…ç½®</h3>
            <div id="configDisplay" class="space-y-2 text-sm">
                <!-- é…ç½®ä¿¡æ¯åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- å¤„ç†ç»“æœå±•ç¤º -->
    <div id="resultSection" class="hidden mt-8">
        <div class="chart-card p-6">
            <h3 class="text-lg font-medium text-indigo-600 mb-4">å¤„ç†ç»“æœ</h3>
            
            <!-- æ•°æ®é¢„è§ˆåŒºåŸŸ -->
            <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-600 mb-2">æ•°æ®é¢„è§ˆ</h4>
            <div id="dataPreview" class="bg-gray-50 rounded-lg p-2 border border-gray-200 overflow-x-auto"></div>
            
        </div>
        

        <!-- åœ¨ç»“æœåŒºåŸŸæ·»åŠ æ¶ˆæ¯å±•ç¤º -->
        <div id="loadingIndicator" class="hidden p-3 bg-blue-100 rounded-lg">
            <i class="fas fa-spinner fa-spin mr-2 text-blue-500"></i>
            æ­£åœ¨å¤„ç†ä¸­...
        </div>
        <div id="messageSection" class="hidden mt-6 space-y-3">
            <div v-for="msg in messages" class="p-3 rounded-lg" 
                 :class="{'bg-blue-100': msg.type === 'status', 
                         'bg-yellow-100': msg.type === 'warning',
                         'bg-red-100': msg.type === 'error'}">
                <i class="fas mr-2" 
                   :class="{'fa-info-circle': msg.type === 'status',
                           'fa-exclamation-triangle': msg.type === 'warning',
                           'fa-times-circle': msg.type === 'error'}"></i>
                {{ msg.content }}
            </div>
        </div>
    </div>
    <form id="resultForm" method="post" action="/back_to_home">
    <div class="flex justify-center">
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            ä¿å­˜å¹¶å›åˆ°ä¸»é¡µ <i class="fas fa-arrow-right ml-2"></i>
        </button>
    </div>
</section>
<style>
    /* æ•°æ®é¢„è§ˆå®¹å™¨ */
    #dataPreview {
        @apply overflow-auto max-h-96; /* æœ€å¤§é«˜åº¦+æ»šåŠ¨æ¡ */
        scrollbar-width: thin; /* çº¤ç»†æ»šåŠ¨æ¡ */
        scrollbar-color: #c7d2fe #f0f4ff; /* æ»šåŠ¨æ¡é¢œè‰² */
    }
    
    /* è¡¨æ ¼æ•´ä½“æ ·å¼ */
    #dataPreview table {
        @apply w-full text-[11px]; /* ç¼©å°å­—ä½“ */
        border-collapse: separate;
        border-spacing: 0;
        min-width: 800px; /* æœ€å°å®½åº¦ä¿è¯è¡¨å¤´å®Œæ•´ */
    }
    
    /* è¡¨å¤´æ ·å¼ */
    #dataPreview thead th {
        @apply bg-indigo-50; /* è°ƒæµ…èƒŒæ™¯è‰² */
        @apply text-indigo-600; /* è°ƒæ•´æ–‡å­—é¢œè‰² */
        @apply px-2 py-1.5; /* ç¼©å°å†…è¾¹è· */
        @apply uppercase; /* è‹±æ–‡è¡¨å¤´è½¬å¤§å†™ */
        @apply tracking-wider; /* å¢åŠ å­—æ¯é—´è· */
        @apply bg-indigo-100 text-indigo-700 px-3 py-2 sticky top-0;
        border-bottom: 2px solid #818cf8; /* åº•éƒ¨è¾¹æ¡† */
        box-shadow: 0 2px 2px -1px rgba(129,140,248,0.1); /* æ‚¬æµ®é˜´å½± */
    }
    
    /* æ–°å¢5: åˆ—å®½ä¼˜åŒ– */
    #dataPreview td:first-child {
        min-width: 160px; /* æ—¶é—´åˆ—æœ€å°å®½åº¦ */
    }
    #dataPreview td:nth-child(n+2):not(:last-child) {
        min-width: 80px; /* ä¸­é—´åˆ—æœ€å°å®½åº¦ */
    }
    #dataPreview td:last-child {
        min-width: 100px; /* åŠŸç‡åˆ—æœ€å°å®½åº¦ */
    }


    /* è¡¨æ ¼å•å…ƒæ ¼ */
    #dataPreview td {
        @apply px-2 py-1; /* ç¼©å°å•å…ƒæ ¼å†…è¾¹è· */
        @apply whitespace-nowrap; /* ç¦æ­¢æ–‡å­—æ¢è¡Œ */
    }
    
    /* æ–‘é©¬çº¹æ•ˆæœ */
    #dataPreview tbody tr:nth-child(even) {
        @apply bg-gray-50; /* å¶æ•°è¡ŒèƒŒæ™¯ */
    }
    
    /* æ‚¬åœæ•ˆæœ */
    #dataPreview tbody tr:hover {
        @apply bg-blue-50; /* æ‚¬åœèƒŒæ™¯ */
        transform: scale(1.002); /* å¾®æ”¾å¤§æ•ˆæœ */
        box-shadow: 0 1px 3px rgba(99,102,241,0.1); /* æ‚¬æµ®é˜´å½± */
    }
    
    /* ç‰¹æ®Šåˆ—é«˜äº® */
    #dataPreview td:first-child {
        @apply font-medium text-indigo-600; /* æ—¶é—´åˆ—ç‰¹æ®Šæ ·å¼ */
    }
    
    #dataPreview td:last-child {
        @apply font-semibold text-green-700; /* åŠŸç‡åˆ—ç‰¹æ®Šæ ·å¼ */
    }
    
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    #dataPreview::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    #dataPreview::-webkit-scrollbar-track {
        @apply bg-indigo-50 rounded;
    }
    
    #dataPreview::-webkit-scrollbar-thumb {
        @apply bg-indigo-300 rounded hover:bg-indigo-400;
        @apply bg-indigo-200; /* è°ƒæµ…æ»šåŠ¨æ¡é¢œè‰² */
        border-radius: 8px;
    }
    </style>

<script>
// åˆå§‹åŒ–åŠ è½½é…ç½®
function loadConfig() {
    fetch('/get_config')
        .then(res => res.json())
        .then(config => {
            // å¡«å……æ–‡ä»¶é€‰æ‹©
            const fileSelect = document.getElementById('fileSelect')
            fileSelect.innerHTML = config.file_options.map(f => 
                `<option ${f === config.current_file ? 'selected' : ''}>${f}</option>`
            ).join('')

            // æ›´æ–°å•é€‰æŒ‰é’®çŠ¶æ€
            const method = config.anomaly_handling?.method || 'delete'
            document.querySelector(`[name="method"][value="${method}"]`).checked = true
            
            // æ›´æ–°æ’å€¼æ–¹æ³•é€‰æ‹©
            const interpolateMethod = config.anomaly_handling?.interpolate_method || 'linear'
            document.querySelector(`[name="interpolate_method"]`).value = interpolateMethod
            
            // å¼ºåˆ¶è§¦å‘changeäº‹ä»¶æ›´æ–°æ˜¾ç¤º
            document.querySelector('[name="method"]:checked').dispatchEvent(new Event('change'))
            
            // æ˜¾ç¤ºå½“å‰é…ç½®
            displayConfig(config)
        })
}

// åŠ¨æ€æ˜¾ç¤ºæ’å€¼é€‰é¡¹
document.addEventListener('DOMContentLoaded', () => {
    // åŠ¨æ€æ˜¾ç¤ºæ’å€¼é€‰é¡¹
    document.querySelectorAll('[name="method"]').forEach(el => {
        el.addEventListener('change', () => {
            const interpolateDiv = document.getElementById('interpolateOptions')
            interpolateDiv.classList.toggle('hidden', el.value !== 'interpolate')
            
            // è‡ªåŠ¨é€‰æ‹©é»˜è®¤æ’å€¼æ–¹æ³•
            if(el.value === 'interpolate' && !document.querySelector('[name="interpolate_method"]').value) {
                document.querySelector('[name="interpolate_method"]').value = 'linear'
            }
        })
    })
    
    // åˆå§‹åŠ è½½é…ç½®
    loadConfig()
})

// ä¿å­˜é…ç½®
function saveConfig() {
    const formData = new FormData(document.getElementById('configForm'))
    const config = {
        current_file: formData.get('current_file'),
        anomaly_handling: {
            method: formData.get('method'),
            interpolate_method: formData.get('interpolate_method')
        }
    }

    fetch('/update_config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    }).then(() => loadConfig())
}

// åº”ç”¨å¤„ç†
function applyProcessing() {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loading = document.getElementById('loadingIndicator');
    loading.classList.remove('hidden');
    
    // æ¸…ç©ºæ—§æ¶ˆæ¯
    document.getElementById('messageSection').innerHTML = '';
    
    fetch('/process_data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(async response => {
        const isJson = response.headers.get('content-type')?.includes('application/json');
        const data = isJson ? await response.json() : null;
        
        if (!response.ok) {
            const error = (data && data.message) || response.statusText;
            throw new Error(error);
        }
        return data;
    })
    .then(data => {
        // ç»Ÿä¸€æ¶ˆæ¯ç»“æ„å¤„ç†
        const messages = {
            status: data.message?.status || [],
            warnings: data.message?.warnings || [],
            errors: data.message?.errors || []
        };
        
        if (data.status === 'success') {
            // æ›´æ–°æ•°æ®é¢„è§ˆ
            document.getElementById('dataPreview').innerHTML = data.preview;
            // æ¸²æŸ“å›¾è¡¨
            renderChart(data.chart_data); 
        }
        
        showProcessingMessages(messages);
    })
    .catch(error => {
        showProcessingMessages({
            errors: [error.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥']
        });
    })
    .finally(() => {
        loading.classList.add('hidden');
        document.getElementById('resultSection').classList.remove('hidden');
    });
}


function renderChart(chartData) {
    try {
        // æ¸…é™¤æ—§å›¾è¡¨
        if(window.myChart instanceof Chart){
            window.myChart.destroy();
        }
        
        const ctx = document.getElementById('anomalyChart').getContext('2d');
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'åŸå§‹æ•°æ®',
                    data: chartData.raw,
                    borderColor: '#ff6384',
                    fill: false
                },{
                    label: 'æ¸…æ´—åæ•°æ®',
                    data: chartData.clean,
                    borderColor: '#4bc0c0',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'æ•°æ®æ¸…æ´—æ•ˆæœå¯¹æ¯”' }
                }
            }
        });
    } catch (e) {
        console.error('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', e);
        showProcessingMessages({
            errors: ['æ•°æ®å¯è§†åŒ–å¤±è´¥ï¼š'+e.message]
        });
    }
}


// åœ¨<script>ä¸­æ·»åŠ é…ç½®æ˜¾ç¤ºé€»è¾‘
function displayConfig(config) {
    const displayDiv = document.getElementById('configDisplay');
    const items = [
        ['å½“å‰æ–‡ä»¶', config.current_file],
        ['å¼‚å¸¸å¤„ç†æ–¹å¼', config.anomaly_handling.method],
        ['æ’å€¼æ–¹æ³•', config.anomaly_handling.interpolate_method || 'N/A'],
        ['ç©ºå€¼ç­–ç•¥', config.data_format.missing_value_strategy],
        ['æœ€å¤§ç©ºå€¼ç‡', `${config.data_format.max_missing_ratio*100}%`]
    ];
    // æ›´æ–°è¡¨å•å…ƒç´ 
    document.querySelector('[name="missing_value_strategy"]').value = 
        config.data_format.missing_value_strategy;
    document.querySelector('[name="max_missing_ratio"]').value = 
        config.data_format.max_missing_ratio;

    displayDiv.innerHTML = items.map(([label, value]) => `
        <div class="flex justify-between py-2 border-b">
            <span class="text-gray-600">${label}</span>
            <span class="text-indigo-600">${value}</span>
        </div>
    `).join('');
    }

// å¢å¼ºæ¶ˆæ¯å±•ç¤ºåŠŸèƒ½
function showProcessingMessages(messages) {
    const container = document.getElementById('messageSection');
    container.classList.remove('hidden');
    
    // æ¸…ç©ºæ—§æ¶ˆæ¯
    container.innerHTML = '';
    
    // åˆ†ç±»æ¸²æŸ“æ¶ˆæ¯
    const messageTypes = {
        'status': {icon: 'fa-info-circle', color: 'text-blue-500'},
        'warnings': {icon: 'fa-exclamation-triangle', color: 'text-yellow-500'},
        'errors': {icon: 'fa-times-circle', color: 'text-red-500'}
    };
    
    Object.entries(messageTypes).forEach(([type, style]) => {
        if(messages[type]) {
            messages[type].forEach(msg => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg mb-2 ${style.color.replace('text','bg')}`;
                div.innerHTML = `
                    <i class="fas ${style.icon} mr-2 ${style.color}"></i>
                    <span class="text-sm">${msg}</span>
                `;
                container.appendChild(div);
            });
        }
    });
}
// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', loadConfig)
</script>
